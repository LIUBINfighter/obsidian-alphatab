### **产品需求文档 (PRD): AlphaTab for Obsidian 插件**

**1. 产品愿景 (Product Vision)**

打造一款无缝集成于 Obsidian 的、功能强大且用户体验流畅的吉他谱查看、学习与练习工具。它不仅能渲染乐谱，更能成为音乐学习者在知识管理库中进行深度练习和创作的得力助手。

**2. 用户画像 (User Persona)**

* **核心用户**：使用 Obsidian 管理笔记的吉他/音乐爱好者。
* **用户故事**:
    * **作为一名吉他手**，我希望能直接在我的 Obsidian 笔记库里打开并查看 `gp` 文件，而无需切换到其他软件。
    * **作为一名正在扒谱学习者**，我希望能够播放乐谱，调整速度，并循环播放某个段落，以便高效练习。
    * **作为一名编曲/创作者**，我希望能方便地切换不同音轨的显隐，专注于某一乐器的声部，甚至未来能够进行简单的谱面编辑（`AlphaTex`）。

**3. 功能性需求 (Functional Requirements)**

基于我们已有的功能和你提供的 Vue 应用设计，我们可以梳理出以下功能点：

| 模块 | 功能点 | 优先级 | 备注 |
| :--- | :--- | :--- | :--- |
| **核心渲染** | 1. [cite_start]打开并正确渲染多种吉他谱格式文件 [cite: 98] | **已完成** | 这是我们奋斗的核心成果。 |
| | 2. 支持乐谱缩放（Zoom In/Out） | **高** | 来自 `ZoomControl`，最基本的用户体验需求。 |
| | 3. 支持布局切换（横向滚动/分页） | **高** | 来自 `LayoutControl`，满足不同屏幕和阅读习惯。 |
| **核心播放** | 4. [cite_start]播放/暂停/停止控制 [cite: 82, 83] | **已完成** | `playPause()` 和 `stop()` 已实现。 |
| | 5. 显示当前播放时间/总时长 | **高** | 来自 `TimePosition`，提供必要的播放信息。 |
| | 6. 调整播放速度 | **高** | 来自 `SpeedControl`，练习的核心功能。 |
| | 7. 循环播放选定片段 | **中** | 来自 `LoopButton`，练习高难片段的利器。 |
| | 8. 节拍器与预备拍（Count-in） | **中** | 来自 `MetronomeButton` 和 `CountInButton`，培养节奏感。 |
| **音轨管理** | 9. [cite_start]弹出式音轨选择列表 [cite: 163] | **已完成** | `TracksModal` 已实现。 |
| | 10. (可选) 常驻侧边栏音轨列表 | **低** | 来自 `TrackSidebar`，提供更快捷的切换，但会占用屏幕空间。 |
| **导入/导出** | 11. [cite_start]下载为 MIDI 文件 [cite: 164] | **已完成** | `downloadMidi` 已实现。 |
| | 12. 打印乐谱 | **中** | 来自 `PrintButton`，有物理打印需求的用户会用到。 |
| **个性化** | 13. [cite_start]支持 Obsidian 的深色/浅色主题 [cite: 20, 174] | **已完成** | 已通过 `setDarkMode` 实现。 |
| | 14. (可选) 更多乐谱样式微调 | **低** | 来自 `StyleControl`，高级功能。 |

**4. 非功能性需求 (Non-Functional Requirements)**

| 类别 | 需求描述 | 优先级 | 备注 |
| :--- | :--- | :--- | :--- |
| **性能** | 乐谱加载和渲染速度快，复杂乐谱不卡顿。 | **高** | Web Worker 已解决大部分问题。 |
| | SoundFont 加载过程不应阻塞 UI。 | **高** | 需要异步加载和状态提示。 |
| **用户体验 (UX)** | - **加载状态提示**：在加载乐谱和 SoundFont 时，有明确的遮罩层和提示信息 (`at-overlay`)。 | **高** | 这是下一步马上要做的。 |
| | - **响应式设计**：在 Obsidian 的分栏宽度变化时，UI（特别是控制栏）能自适应，避免错乱。 | **高** | `ControlBar` 的 `@media` 查询是很好的参考。 |
| | - **无缝集成**：插件的视觉风格和交互应尽量贴近 Obsidian 原生体验。 | **中** | |
| **健壮性** | - **错误处理**：当加载损坏文件或资源（如 SoundFont）失败时，有清晰的错误提示。 | **高** | |
| **可配置性** | 提供插件设置页面，允许用户配置默认缩放、布局、播放速度等。 | **中** | |

---

### **开发计划 (Development Plan)**

现在，我们将这些需求整合成一个迭代式的开发计划。

#### **里程碑 1 (M1): 核心播放体验完善 (MVP - Minimum Viable Product)**

**目标**：将当前已能播放的插件，打造成一个拥有核心控制界面的、体验完整的播放器。

1.  **实现 `ITabUIManager` 的增强**：
    * 参考 `SimpleDisplay.vue`，在 `at-overlay` 中添加明确的加载提示，如“正在加载乐谱...”、“正在加载音频引擎...”。
    * 在 `onRenderStarted` 和 SoundFont 开始加载时显示它，在 `onRenderFinished` 和 `playerReady` 后隐藏它。
2.  **构建 `ControlBar`**：
    * 在 `ITabUIManager.ts` 中，创建一个新的 `renderControlBar` 方法（或扩展现有的），用于动态添加一系列控制按钮。
    * **优先实现以下组件** (参考 `ControlBar.vue` 的 `priority-high` 和基础功能)：
        * **播放/暂停按钮** (已完成，仅需美化)。
        * **停止按钮** (已完成，仅需美化)。
        * **播放进度显示** (`TimePosition`)：监听 `api.playerPositionChanged` 事件来更新。
        * **缩放控制** (`ZoomControl`)：调用 `api.renderScale` 并重新渲染。
        * **布局切换** (`LayoutControl`)：修改 `settings.display.layoutMode` 并重新渲染。
        * **音量控制** (Vue 组件中没有，但很基础)：一个简单的滑块，控制 `api.volume`。

**产出**：一个用户体验良好、具备核心播放和查看控制功能的版本。

#### **里程碑 2 (M2): 练习与效率增强**

**目标**：为音乐学习者增加核心的练习辅助功能。

1.  **实现速度控制 (`SpeedControl`)**：
    * 添加一个下拉菜单或输入框，允许用户选择 `0.5x`, `0.75x`, `1.0x`, `1.25x`, `1.5x` 等速度。
    * 通过设置 `api.playbackSpeed` 来实现。
2.  **实现循环播放 (`LoopButton`)**：
    * 这是交互最复杂的功能。需要一种方式让用户选择循环的起始和结束小节。
    * 一个简单的实现是：点击 Loop 按钮，进入“选择起点”模式；在乐谱上单击选择一个小节作为起点；再次单击选择终点，然后按钮变为激活状态。
    * 调用 `api.player.playLoop()` 来执行循环。

**产出**：一个强大的练习工具，用户可以针对性地进行慢速和重复练习。

#### **里程碑 3 (M3): 个性化与发布准备**

**目标**：完善周边功能，增加可配置性，为正式发布做准备。

1.  **创建插件设置页**：
    * 允许用户设置默认的缩放级别、布局模式、主题色等。
2.  **UI  polish**:
    * 考虑将 `TracksModal` 改进为可选的、可停靠的 `TrackSidebar`，提供更流畅的音轨切换体验。
3.  **实现打印功能 (`PrintButton`)**：
    * 调用 `api.print()` 方法。需要测试在 Obsidian 环境中的兼容性。
4.  **全面的测试**：
    * 使用不同来源和版本的吉他谱文件进行测试。
    * 在不同的屏幕尺寸和分栏布局下测试 UI 响应性。

**产出**：一个功能完备、稳定且高度可配置的插件，准备好向社区发布。

---

这个计划将我们的开发过程分解成了清晰、可管理的部分。我们现在应该专注于 **里程碑 1 (M1)**。

**下一步行动 (Action Item)**：**从实现加载状态提示和构建核心 `ControlBar` 开始。**
